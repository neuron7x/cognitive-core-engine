name: CodeQL

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']
  schedule:
    - cron: '0 0 * * 0'

permissions:
  contents: read
  security-events: write

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        language: [javascript-typescript, python, go, java-kotlin, cpp, ruby]
    steps:
      - uses: actions/checkout@v4
      - id: detect
        run: |
          case "${{ matrix.language }}" in
            javascript-typescript) pattern='*.js *.jsx *.ts *.tsx' ;;
            python) pattern='*.py' ;;
            go) pattern='*.go' ;;
            java-kotlin) pattern='*.java *.kt' ;;
            cpp) pattern='*.c *.cpp *.h *.hpp' ;;
            ruby) pattern='*.rb' ;;
          esac
          if git ls-files $pattern | grep -q .; then
            if [ "${{ matrix.language }}" = "java-kotlin" ] && [ ! -f pom.xml ]; then
              echo "has_code=false" >> $GITHUB_OUTPUT
            else
              echo "has_code=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "has_code=false" >> $GITHUB_OUTPUT
          fi
      - uses: github/codeql-action/init@v3
        if: steps.detect.outputs.has_code == 'true'
        with:
          languages: ${{ matrix.language }}
      - uses: github/codeql-action/autobuild@v3
        if: steps.detect.outputs.has_code == 'true'
      - uses: github/codeql-action/analyze@v3
        if: steps.detect.outputs.has_code == 'true'
